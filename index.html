<!DOCTYPE html>
<html>
<style type="text/css">
    #header:after {
        content: 'off';
    }

    #header.capslock:after {
        content: 'on';
        background: red;
    }
</style>
<script>

    var finalState = null;
    const isMacOs = navigator.platform.startsWith("Mac") || /Mac/i.test(navigator.userAgent);
    const isLinux = navigator.platform.startsWith("Linux") || /Linux/i.test(navigator.userAgent);
    const isWindows = navigator.platform.startsWith("Win") || /Win/i.test(navigator.userAgent);

    let logs;

    addEventListener("DOMContentLoaded", () => {
        const os = isMacOs ? "macos" : isLinux ? "linux" : isWindows ? "windows" : unknown;

        const pre = document.createElement("pre");
        pre.innerText = `os: ${os}\nplatform: ${navigator.platform}\nuserAgent: ${navigator.userAgent}\n`;
        document.body.append(pre);
        logs = document.getElementById("logs");
    })

    function updateIndicator() {
        console.log("capslock is ", finalState ? "on" : "off");
        logs.innerText += `\ncapslock is ${finalState ? "on" : "off"}`;

        if (finalState) {
            document.getElementById('header').classList = ['capslock'];
        } else {
            document.getElementById('header').classList = [];
        }
    }

    function isCapsLockOn() {
        return event.getModifierState("CapsLock");
    }


    document.addEventListener("keyup", event => {
        console.log({ e: event.type, key: event.key, capsLock: event.getModifierState("CapsLock") });
        logs.innerText += "\n" + JSON.stringify({ e: event.type, key: event.key, capsLock: event.getModifierState("CapsLock") });
        /* macOs sends only keyDown when enabling CapsLock and only keyUp when disabling. */
        if (isMacOs) {
            if (event.key === "CapsLock") {
                finalState = false;
            } else {
                finalState = isCapsLockOn(event);
            }
        }
        else if (isWindows) {
            /* Windows always sends the correct state on keyup */
            finalState = isCapsLockOn(event);
        } else if (event.key !== "CapsLock") {
            finalState = isCapsLockOn(event);
        }

        updateIndicator();
        document.getElementById('text').append(event.key + " ");
    });

    document.addEventListener("keydown", event => {
        console.log({ e: event.type, key: event.key, capsLock: event.getModifierState("CapsLock") });
        logs.innerText += "\n" + JSON.stringify({ e: event.type, key: event.key, capsLock: event.getModifierState("CapsLock") });
        /* macOs sends only keyDown when enabling CapsLock and only keyUp when disabling. */
        if (isMacOs) {
            if (event.key === "CapsLock") {
                finalState = true;
                updateIndicator();
            }
        } else if (isLinux) {
            /* Linux sends the correct state before the toggle only on keydown, so we invert the modifier state */
            if (event.key === "CapsLock") {
                finalState = !isCapsLockOn(event);
            }
        }
    })

</script>

<body>
    <h1 id="header">Caps-Lock is </h1>
    type some text or toggle caps lock...
    <div id="text"></div>

    <textarea></textarea>
    <br />
    <br />
    <h2>logs</h2>
    <pre id="logs"></pre>
</body>

</html>